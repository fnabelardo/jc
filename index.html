<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8"/>
    <title>Pawn Calculator</title>
    <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
            rel="stylesheet"
    />
</head>
<body class="bg-light py-5">
<div class="container">
    <div class="card shadow p-4">
        <h2 class="text-center">Pawn's month calculator</h2>

        <div class="alert alert-info" id="resultInit"></div>

        <div class="row mb-3">
            <div class="col-md-6">
                <label class="form-label">Pawn Date:</label>
                <input type="date" class="form-control" id="pawnDate"/>
            </div>
            <div class="col-md-6">
                <label class="form-label">Pawn Amount:</label>
                <input
                        type="number"
                        class="form-control"
                        id="pawnAmount"
                        placeholder="Insert the amount"
                />
            </div>
        </div>

        <div class="row mb-3">
            <div class="col-md-6">
                <label class="form-label">Months Paid:</label>
                <input
                        type="number"
                        class="form-control"
                        id="monthsPaid"
                        value="0"
                />
            </div>
            <div class="col-md-6">
                <label class="form-label">The initial amount was reduced?</label>
                <select class="form-select" id="initialAmountReduced">
                    <option value="no">No</option>
                    <option value="yes">Yes</option>
                </select>
            </div>
        </div>

        <div class="border-top pt-3 mt-3">
            <h5>Settings</h5>
            <div class="row mb-3">
                <div class="col-md-6">
                    <label class="form-label">Monthly interest (%):</label>
                    <input
                            type="number"
                            class="form-control"
                            id="monthlyInterest"
                            value="10"
                    />
                </div>
                <div class="col-md-6">
                    <label class="form-label">Days of Grace:</label>
                    <input
                            type="number"
                            class="form-control"
                            id="daysGrace"
                            value="3"
                    />
                </div>
            </div>

            <div class="mb-3">
                <label class="form-label">Current Day (optional):</label>
                <input type="date" class="form-control" id="currentDate"/>
            </div>
        </div>

        <div class="d-grid gap-2">
            <button class="btn btn-success" onclick="calculateMonths()">
                Calculate
            </button>
            <button class="btn btn-danger" onclick="resetFields()">Reset</button>
        </div>

        <div class="alert alert-info mt-2" id="resultLast"></div>
    </div>
</div>

<script>
    document.getElementById("pawnDate").valueAsDate = new Date();
    document.getElementById("currentDate").valueAsDate = new Date();

    //## Set the default time zone (America/New_York) 
    const options = {
        timeZone: 'America/New_York',
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
    };

    const formatter = new Intl.DateTimeFormat('es-ES', options);    

    function calculateMonths() {
        const amount = parseFloat(document.getElementById("pawnAmount").value);

        const pawnDate = document.getElementById("pawnDate").value;
        const [yearPawnDate, monthPawnDate, dayPawnDate] = pawnDate.split('-').map(Number);
        let pawnDateFixed = new Date(yearPawnDate, monthPawnDate - 1, dayPawnDate);

        const currentDateInput = document.getElementById("currentDate").value;
        const [yearCurrentDateInput, monthCurrentDateInput, dayCurrentDateInput] = currentDateInput.split('-').map(Number);
        let currentDateInputFixed = new Date(yearCurrentDateInput, monthCurrentDateInput - 1, dayCurrentDateInput);
        const interest = parseFloat(document.getElementById("monthlyInterest").value);
        let daysGrace = parseInt(document.getElementById("daysGrace").value);
        const initialAmountReduced = document.getElementById(
            "initialAmountReduced"
        ).value;
        const monthsPaid = parseInt(
            document.getElementById("monthsPaid").value
        );

        if (initialAmountReduced === "yes") daysGrace = 0;
        let today = currentDateInputFixed ? new Date(currentDateInputFixed) : new Date();

        if (isNaN(pawnDateFixed.getTime())) {
            document.getElementById("result").innerText =
                "Please enter valid date.";
            return;
        }

        if (isNaN(amount)) {
            document.getElementById("result").innerText =
                "Please enter valid quantity.";
            return;
        }

        let startMonthDate = new Date(pawnDateFixed);
        startMonthDate.setDate(1);
        let currentDate = new Date(today);
        currentDate.setDate(1);

        let months = (currentDate.getFullYear() - startMonthDate.getFullYear()) * 12;
        months += currentDate.getMonth() - startMonthDate.getMonth();

        const pawnDateDate = pawnDateFixed.getDate();
        const todayDate = today.getDate();

        if (months === 0) daysGrace = 0;

        let haveDaysGrace = false;
        let pawnDaysGrace = new Date(pawnDateFixed);
        //## Set the full date
        pawnDaysGrace.setFullYear(currentDateInputFixed.getFullYear(), currentDateInputFixed.getMonth(), currentDateInputFixed.getDate());
        
        //## Format the dates
        pawnDaysGrace = formatter.format(pawnDaysGrace);
        currentDateInputFixed = formatter.format(currentDateInputFixed);
        pawnDateFixed = formatter.format(pawnDateFixed);

        console.log(`currentDateInputFixed: ${currentDateInputFixed}`)
        console.log(`pawnDateDate: ${pawnDateDate}`)
        console.log(`pawnDateFixed + daysGrace: ${pawnDaysGrace}`)
        console.log(`haveDaysGrace: ${haveDaysGrace}`)

        //## Months owed
        if (months <= 0) months = 1;
        let monthOwed = months - monthsPaid;
        if (monthOwed < 0) monthOwed = 1;

        if (
            daysGrace > 0 && currentDateInputFixed <= pawnDaysGrace
        ) {
            haveDaysGrace = true;
        }

        console.log(`monthOwedInit: ${monthOwed}`)

        monthOwed = haveDaysGrace && monthOwed > 1 ? monthOwed - 1 : monthOwed;

        console.log(`monthOwedLast: ${monthOwed}`)

        const totalInterestPercent = (interest / 100) * monthOwed;
        const monthlyPaid = Math.ceil(amount <= 50 ? 5 : amount * (interest / 100));
        const moneyInterest = monthOwed * monthlyPaid;
        const totalToPay = amount + moneyInterest;
        
        const result = `
        Owe <strong>${monthOwed}</strong> month(s).<br>
        ${
                haveDaysGrace
                        ? '<span class="text-success">Have grace day.</span><br>'
                        : ""
        }
        Monthly paid: <strong>$${monthlyPaid.toFixed(2)}</strong><br>
        Money interest: <strong>$${moneyInterest.toFixed(2)}</strong><br>
        Total to pay ($${amount.toFixed(2)} + $${moneyInterest.toFixed(2)}): <strong>$${totalToPay.toFixed(2)}</strong>
      `;

        document.getElementById("resultInit").innerHTML = result
        document.getElementById("resultLast").innerHTML = result
    }

    function resetFields() {
        document.getElementById("pawnAmount").value = "";
        document.getElementById("pawnDate").value = "";
        document.getElementById("monthsPaid").value = 0;
        document.getElementById("initialAmountReduced").value = "no";
        document.getElementById("monthlyInterest").value = 10;
        document.getElementById("daysGrace").value = 3;
        document.getElementById("currentDate").valueAsDate = new Date();
        document.getElementById("result").innerHTML = "";
    }
</script>
</body>
</html>
